# ‚ö° Power Monitor Dual Channel (PZEM-004T + XIAO ESP32-C3)

–ù–∞–¥—ñ–π–Ω–µ —Ä—ñ—à–µ–Ω–Ω—è –¥–ª—è –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É –¥–≤–æ—Ö –Ω–µ–∑–∞–ª–µ–∂–Ω–∏—Ö –ª—ñ–Ω—ñ–π (—Ñ–∞–∑) –µ–ª–µ–∫—Ç—Ä–æ–º–µ—Ä–µ–∂—ñ –Ω–∞ –±–∞–∑—ñ ESPHome. –ü—Ä–æ–µ–∫—Ç —Ä–æ–∑—Ä–æ–±–ª–µ–Ω–∏–π –∑ –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ —Å—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å —Ä–æ–±–æ—Ç–∏ –≤ —É–º–æ–≤–∞—Ö –Ω–µ—Å—Ç–∞–±—ñ–ª—å–Ω–æ–≥–æ –∂–∏–≤–ª–µ–Ω–Ω—è —Ç–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è UPS.



## ‚ú® –û—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ (v26.01.02.4)
- **–ü—ñ–¥—Ç—Ä–∏–º–∫–∞ –¥–≤–æ—Ö —Ñ–∞–∑**: –û–∫—Ä–µ–º—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏ –¥–ª—è –∫–æ–∂–Ω–æ—ó –ª—ñ–Ω—ñ—ó + –∑–∞–≥–∞–ª—å–Ω–∞ –ø–æ—Ç—É–∂–Ω—ñ—Å—Ç—å.
- **UPS-–∞–¥–∞–ø—Ç–∞—Ü—ñ—è**: –†–æ–∑—É–º–Ω–∏–π Watchdog –≤—ñ–¥–Ω–æ–≤–ª—é—î –∑–≤'—è–∑–æ–∫, —è–∫—â–æ 220–í –∑–Ω–∏–∫–∞–ª–æ, –∞ ESP32 –∑–∞–ª–∏—à–∞–≤—Å—è —É–≤—ñ–º–∫–Ω–µ–Ω–∏–º.
- **–ë–∞–≥–∞—Ç–æ—Ä—ñ–≤–Ω–µ–≤–∏–π –∑–∞—Ö–∏—Å—Ç**:
  - **Soft UART Reset**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –æ—á–∏—â–µ–Ω–Ω—è —à–∏–Ω–∏ –¥–∞–Ω–∏—Ö —á–µ—Ä–µ–∑ 2 —Ö–≤ –±–µ–∑ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ.
  - **Hard Reboot**: –ü–æ–≤–Ω–µ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∞ —á–µ—Ä–µ–∑ 5 —Ö–≤ –±–µ–∑ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ.
- **–ü–æ–≤–Ω—ñ –º–µ—Ç—Ä–∏–∫–∏**: –ù–∞–ø—Ä—É–≥–∞, –ü–æ—Ç—É–∂–Ω—ñ—Å—Ç—å, –ï–Ω–µ—Ä–≥—ñ—è, –ß–∞—Å—Ç–æ—Ç–∞ (Hz) —Ç–∞ –ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç –ø–æ—Ç—É–∂–Ω–æ—Å—Ç—ñ (PF).
- **–î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞**: –ö–Ω–æ–ø–∫–∏ —Å–µ—Ä–≤—ñ—Å–Ω–æ–≥–æ —Å–∫–∏–¥–∞–Ω–Ω—è —Ç–∞ —Å—Ç–∞—Ç—É—Å –∑–≤'—è–∑–∫—É (connectivity) –ø—Ä—è–º–æ –≤ Home Assistant.

## üõ† –ê–ø–∞—Ä–∞—Ç–Ω–µ –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è
- **–ö–æ–Ω—Ç—Ä–æ–ª–µ—Ä**: [Seeed Studio XIAO ESP32-C3](https://www.seeedstudio.com/Seeed-Studio-XIAO-ESP32C3-p-5431.html).
- **–°–µ–Ω—Å–æ—Ä–∏**: 2x PZEM-004T V3.0.
- **–ñ–∏–≤–ª–µ–Ω–Ω—è**: ESP32 –∂–∏–≤–∏—Ç—å—Å—è –≤—ñ–¥ UPS (5V USB), PZEM –∂–∏–≤–ª—è—Ç—å—Å—è –≤—ñ–¥ –≤–∏–º—ñ—Ä—é–≤–∞–Ω–æ—ó –º–µ—Ä–µ–∂—ñ AC 220V.

### –°—Ö–µ–º–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è (Pinout)
| XIAO ESP32-C3 | PZEM-004T (Module 1 & 2) | –û–ø–∏—Å |
| :--- | :--- | :--- |
| **5V** | **VCC** | –ñ–∏–≤–ª–µ–Ω–Ω—è –ª–æ–≥—ñ–∫–∏ |
| **GND** | **GND** | –°–ø—ñ–ª—å–Ω–∞ –∑–µ–º–ª—è |
| **D6 (GPIO21)** | **RX** | –ü–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–∏—Ö (TX –Ω–∞ ESP) |
| **D7 (GPIO20)** | **TX** | –ü—Ä–∏–π–æ–º –¥–∞–Ω–∏—Ö (RX –Ω–∞ ESP) |

> **–í–∞–∂–ª–∏–≤–æ:** –ú–æ–¥—É–ª—ñ PZEM –ø—ñ–¥–∫–ª—é—á–∞—é—Ç—å—Å—è –¥–æ ESP32 –ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ –Ω–∞ –æ–¥–Ω—É —à–∏–Ω—É UART.

## ‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∞–¥—Ä–µ—Å PZEM
–î–ª—è —Ä–æ–±–æ—Ç–∏ –¥–≤–æ—Ö –º–æ–¥—É–ª—ñ–≤ –Ω–∞ –æ–¥–Ω—ñ–π —à–∏–Ω—ñ —ó–º –ø–æ—Ç—Ä—ñ–±–Ω–æ –ø—Ä–∏–∑–Ω–∞—á–∏—Ç–∏ —Ä—ñ–∑–Ω—ñ Modbus-–∞–¥—Ä–µ—Å–∏ (–∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º —É –≤—Å—ñ—Ö `1`).

1. –ü—ñ–¥–∫–ª—é—á—ñ—Ç—å **—Ç—ñ–ª—å–∫–∏ –æ–¥–∏–Ω** –º–æ–¥—É–ª—å –¥–æ ESP.
2. –ü–æ–¥–∞–π—Ç–µ –Ω–∞ –Ω—å–æ–≥–æ 220–í (–≤–∏–º—ñ—Ä—é–≤–∞–ª—å–Ω–∞ —á–∞—Å—Ç–∏–Ω–∞ –º–∞—î –±—É—Ç–∏ –∑–∞–∂–∏–≤–ª–µ–Ω–∞).
3. –ü—Ä–æ—à–∏–π—Ç–µ ESP —Ñ–∞–π–ª–æ–º `utils/pzem_address_fixer.yaml`.
4. –£ –≤–µ–±-—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ñ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É **"Set Address to 2"**.
5. –ü–æ–≤—Ç–æ—Ä—ñ—Ç—å –¥–ª—è —ñ–Ω—à–æ–≥–æ –º–æ–¥—É–ª—è (—è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–º—ñ–Ω–∏—Ç–∏ –Ω–∞ 3).
6. –¢–µ–ø–µ—Ä –ø—ñ–¥–∫–ª—é—á—ñ—Ç—å –æ–±–∏–¥–≤–∞ –º–æ–¥—É–ª—ñ –ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ —Ç–∞ –ø—Ä–æ—à–∏–π—Ç–µ –æ—Å–Ω–æ–≤–Ω–∏–π –∫–æ–Ω—Ñ—ñ–≥.



## üè† –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –∑ Home Assistant
–î–ª—è —Ç–æ—á–Ω–æ–≥–æ –æ–±–ª—ñ–∫—É –µ–Ω–µ—Ä–≥—ñ—ó –∑–∞ —Ç–∏–∂–¥–µ–Ω—å/–º—ñ—Å—è—Ü—å —Ä–µ–∫–æ–º–µ–Ω–¥—É—î—Ç—å—Å—è –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –≤–±—É–¥–æ–≤–∞–Ω—ñ Helper-–∏:

1. **Riemann Sum Integral**:
   - –í—Ö—ñ–¥: `Power Monitor 01 Total Power`
   - –ú–µ—Ç–æ–¥: `Left`
   - –†–µ–∑—É–ª—å—Ç–∞—Ç: `Total Energy (kWh)`
2. **Utility Meter**:
   - –í—Ö—ñ–¥: –í–∞—à Riemann —Å–µ–Ω—Å–æ—Ä.
   - –¶–∏–∫–ª: `Weekly` / `Monthly`.



## üìù Troubleshooting
- **–°—Ç–∞—Ç—É—Å "Disconnected"**: –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å 220–í –Ω–∞ –º–æ–¥—É–ª—ñ PZEM (–ª–æ–≥—ñ–∫–∞ –±–µ–∑ 220–í –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î) —Ç–∞ —Å–ø—ñ–ª—å–Ω–∏–π GND.
- **–ó–Ω–∞—á–µ–Ω–Ω—è 0 –∞–±–æ NaN**: Watchdog —Å–ø—Ä–æ–±—É—î —Å–∫–∏–Ω—É—Ç–∏ UART –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ª–æ–≥ –Ω–∞ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –∑–∞–ø–∏—Å—ñ–≤ `watchdog: Attempting soft UART reset`.
- **–ü–æ–º–∏–ª–∫–∏ –∫–æ–º–ø—ñ–ª—è—Ü—ñ—ó**: –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ –≤–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç–µ –æ—Å—Ç–∞–Ω–Ω—é –≤–µ—Ä—Å—ñ—é ESPHome —Ç–∞ `esp-idf` framework.

## üìÑ –õ—ñ—Ü–µ–Ω–∑—ñ—è
–¶–µ–π –ø—Ä–æ–µ–∫—Ç —Ä–æ–∑–ø–æ–≤—Å—é–¥–∂—É—î—Ç—å—Å—è –ø—ñ–¥ –ª—ñ—Ü–µ–Ω–∑—ñ—î—é MIT. –í–∏ –º–æ–∂–µ—Ç–µ –≤—ñ–ª—å–Ω–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Ç–∞ –º–æ–¥–∏—Ñ—ñ–∫—É–≤–∞—Ç–∏ –π–æ–≥–æ.
